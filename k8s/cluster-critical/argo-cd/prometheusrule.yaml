apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: argocd-alerts
  namespace: argocd
  labels:
    release: kube-prometheus-stack
spec:
  groups:
    - name: argocd.rules
      rules:
        - alert: ArgoCDApplicationOutOfSync
          expr: argocd_app_info{sync_status!="Synced"}
          for: 5m # Alert after 5 minutes of being out of sync
          labels:
            severity: warning
            service: argocd
            app_name: "{{ $labels.name }}"
            app_namespace: "{{ $labels.namespace }}"
          annotations:
            summary: "üîÑ ArgoCD App Out of Sync: {{ $labels.name }}"
            description: |
              üêô **ArgoCD Application Issue**

              **App:** `{{ $labels.name }}`
              **Namespace:** `{{ $labels.namespace }}`
              **Status:** `{{ $labels.sync_status }}`
              **Project:** `{{ $labels.project }}`
              **Repo:** `{{ $labels.repo }}`

              ‚è∞ **Duration:** > 5 minutes
              üîó **ArgoCD:** [View App](https://argocd.k8s.javydekoning.com/applications/{{ $labels.name }})
            runbook_url: "https://github.com/javydekoning/homelab/blob/main/k8s/cluster-critical/argo-cd/argocd-sync-issues.md"
        - alert: ArgoCDApplicationNotHealthy
          expr: argocd_app_info{health_status!="Healthy"}
          for: 5m # Alert after 5 minutes of being not healthy
          labels:
            severity: warning
            service: argocd
            app_name: "{{ $labels.name }}"
            app_namespace: "{{ $labels.namespace }}"
          annotations:
            summary: "‚ö†Ô∏è ArgoCD App Unhealthy: {{ $labels.name }}"
            description: |
              üêô  **ArgoCD Application Issue**

              **App:** `{{ $labels.name }}`
              **Namespace:** `{{ $labels.namespace }}`
              **Health:** `{{ $labels.health_status }}`
              **Sync:** `{{ $labels.sync_status }}`
              **Project:** `{{ $labels.project }}`
              **Repo:** `{{ $labels.repo }}`

              ‚è∞ **Duration:** > 5 minutes
              üîó **ArgoCD:** [View App](https://argocd.k8s.javydekoning.com/applications/{{ $labels.name }})
            runbook_url: "https://github.com/javydekoning/homelab/blob/main/k8s/cluster-critical/argo-cd/argocd-sync-issues.md"
        - alert: ArgoCDApplicationSyncFailed
          expr: argocd_app_info{sync_status="Unknown"} or argocd_app_info{operation_sync_status="Failed"}
          for: 2m
          labels:
            severity: critical
            service: argocd
            app_name: "{{ $labels.name }}"
            app_namespace: "{{ $labels.namespace }}"
          annotations:
            summary: "‚ùå ArgoCD Sync Failed: {{ $labels.name }}"
            description: |
              üêô  **ArgoCD Sync Failure**

              **App:** `{{ $labels.name }}`
              **Namespace:** `{{ $labels.namespace }}`
              **Sync Status:** `{{ $labels.sync_status }}`
              **Project:** `{{ $labels.project }}`

              üö® **Action Required:** Manual intervention needed
              üîó **ArgoCD:** [View App](https://argocd.k8s.javydekoning.com/applications/{{ $labels.name }})
            runbook_url: "https://github.com/javydekoning/homelab/blob/main/k8s/cluster-critical/argo-cd/argocd-sync-issues.md"
