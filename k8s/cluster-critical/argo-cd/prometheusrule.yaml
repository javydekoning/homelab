apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: argocd-alerts
  namespace: argocd
  labels:
    release: kube-prometheus-stack
spec:
  groups:
    - name: argocd.rules
      rules:
        - alert: ArgoCDApplicationOutOfSync
          expr: argocd_app_info{sync_status!="Synced"}
          for: 5m # Alert after 5 minutes of being out of sync
          labels:
            severity: warning
            service: argocd
            app_name: "{{ $labels.name }}"
            app_namespace: "{{ $labels.namespace }}"
          annotations:
            summary: "🔄 ArgoCD App Out of Sync: {{ $labels.name }}"
            description: |
              🐙 ArgoCD Application Issue
              - ⏰ Duration: > 5 minutes
              - App: {{ $labels.name }}
              - Namespace: {{ $labels.namespace }}
              - Status: {{ $labels.sync_status }}
              - Project: {{ $labels.project }}
              - Repo: {{ $labels.repo }}
            argo_url: "https://argocd.k8s.javydekoning.com/applications/{{ $labels.name }}"
            runbook_url: "https://github.com/javydekoning/homelab/blob/main/k8s/cluster-critical/argo-cd/argocd-sync-issues.md"
        - alert: ArgoCDApplicationNotHealthy
          expr: argocd_app_info{health_status!="Healthy"}
          for: 5m # Alert after 5 minutes of being not healthy
          labels:
            severity: warning
            service: argocd
            app_name: "{{ $labels.name }}"
            app_namespace: "{{ $labels.namespace }}"
          annotations:
            summary: "⚠️ ArgoCD App Unhealthy: {{ $labels.name }}"
            description: |
              🐙 ArgoCD App Health Issue
              - ⏰ Duration: > 5 minutes
              - App: {{ $labels.name }}
              - Namespace: {{ $labels.namespace }}
              - Status: {{ $labels.sync_status }}
              - Project: {{ $labels.project }}
              - Repo: {{ $labels.repo }}
            argo_url: "https://argocd.k8s.javydekoning.com/applications/{{ $labels.name }}"
            runbook_url: "https://github.com/javydekoning/homelab/blob/main/k8s/cluster-critical/argo-cd/argocd-sync-issues.md"
        - alert: ArgoCDApplicationSyncFailed
          expr: argocd_app_info{sync_status="Unknown"} or argocd_app_info{operation_sync_status="Failed"}
          for: 2m
          labels:
            severity: critical
            service: argocd
            app_name: "{{ $labels.name }}"
            app_namespace: "{{ $labels.namespace }}"
          annotations:
            summary: "❌ ArgoCD Sync Failed: {{ $labels.name }}"
            description: |
              🐙 ArgoCD Sync Issue
              - ⏰ Duration: > 2 minutes
              - App: {{ $labels.name }}
              - Namespace: {{ $labels.namespace }}
              - Status: {{ $labels.sync_status }}
              - Project: {{ $labels.project }}
              - Repo: {{ $labels.repo }}
            argo_url: "https://argocd.k8s.javydekoning.com/applications/{{ $labels.name }}"
            runbook_url: "https://github.com/javydekoning/homelab/blob/main/k8s/cluster-critical/argo-cd/argocd-sync-issues.md"
