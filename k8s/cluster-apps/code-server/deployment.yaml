apiVersion: apps/v1
kind: Deployment
metadata:
  name: code-server
  namespace: default
  labels:
    app: code-server
spec:
  selector:
    matchLabels:
      app: code-server
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: code-server
    spec:
      containers:
        - name: code-server
          image: ghcr.io/coder/code-server:latest@sha256:6b8c0e944caec80057e71d2c2f352cee38fe00ae4b7515fc4458eb300844f699
          imagePullPolicy: IfNotPresent
          args: [
              "--auth", "none",
              "--user-data-dir", "/code/.vscode",
              "--extensions-dir", "/code/.vscode",
              "--port", "8080",
              "/code"
            ]
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /
              port: http
          readinessProbe:
            httpGet:
              path: /
              port: http
          volumeMounts:
            - name: config
              mountPath: /code
            - name: conffiles
              mountPath: /code/config
            - name: homelab
              mountPath: /code/homelab
      volumes:
        - name: config
          hostPath:
            path: /config/code-server
            type: DirectoryOrCreate
        - name: conffiles
          hostPath:
            path: /config
            type: DirectoryOrCreate
        - name: homelab
          hostPath:
            path: /root/homelab
            type: DirectoryOrCreate
      restartPolicy: Always
