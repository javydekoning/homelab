apiVersion: v1
kind: ConfigMap
metadata:
  name: config
  labels:
    app: adguard
data:
  AdGuardHome.yaml: |
    bind_host: 0.0.0.0
    bind_port: 80
    language: en
    dns:
      bind_hosts:
        - 0.0.0.0
      port: 53
      statistics_interval: 1
      querylog_enabled: true
      querylog_file_enabled: true
      querylog_interval: 168h
      querylog_size_memory: 1000
      anonymize_client_ip: false
      upstream_dns:
        - https://dns10.quad9.net/dns-query
      bootstrap_dns:
        - 9.9.9.10
        - 149.112.112.10
        - 2620:fe::10
        - 2620:fe::fe:10
      trusted_proxies:
        - 127.0.0.0/8
        - ::1/128
      cache_size: 4194304
      cache_ttl_min: 0
      cache_ttl_max: 60
      rewrites:
        - domain: '*.k8s.javydekoning.com'
          answer: 192.168.1.200
        - domain: 'unifi'
          answer: 192.168.1.254
      upstream_timeout: 2s
    tls:
      enabled: false
    filters:
      - enabled: true
        url: https://adguardteam.github.io/AdGuardSDNSFilter/Filters/filter.txt
        name: AdGuard DNS filter
        id: 1
      - enabled: true
        url: https://adaway.org/hosts.txt
        name: AdAway
        id: 2
      - enabled: true
        url: https://v.firebog.net/hosts/Easyprivacy.txt
        name: TelemetryBlock
        id: 3
      - enabled: true
        url: https://raw.githubusercontent.com/DandelionSprout/adfilt/master/Alternate%20versions%20Anti-Malware%20List/AntiMalwareHosts.txt
        name: MaliciousListBlock
        id: 4
    dhcp:
      enabled: false
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: adguard
  namespace: default
  labels:
    app: adguard
spec:
  selector:
    matchLabels:
      app: adguard
  replicas: 1
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: adguard
    spec:
      initContainers:
        - name: copyconfig
          image: busybox
          command:
            - "sh"
            - "-c"
            - |
              if [ ! -f /opt/adguardhome/conf/AdGuardHome.yaml ]; then
                mkdir -p /opt/adguardhome/conf
                ls /sourceconf
                cp /sourceconf/AdGuardHome.yaml /opt/adguardhome/conf/AdGuardHome.yaml
                ls /opt/adguardhome/conf
              fi
          volumeMounts:
            - name: configmap
              mountPath: /sourceconf
            - name: config
              mountPath: /opt/adguardhome/conf
      containers:
        - name: adguard
          image: adguard/adguardhome:beta@sha256:c471a46ec272d1c889537a476daacceab5585bcb7a4af193836e97b7d67e570d
          imagePullPolicy: IfNotPresent
          env:
            - name: TZ
              value: Europe/Amsterdam
          ports:
            - containerPort: 53
            - containerPort: 80
          volumeMounts:
            - name: config
              mountPath: /opt/adguardhome/conf
      volumes:
        - name: configmap
          configMap:
            name: config
        - name: config
          emptyDir: {}
      restartPolicy: Always
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: adguard-ingress
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - adguard.k8s.javydekoning.com
      secretName: javydekoning-com-tls
  rules:
    - host: adguard.k8s.javydekoning.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: adguard
                port:
                  name: http
---
apiVersion: v1
kind: Service
metadata:
  name: adguard
  namespace: default
  annotations:
    metallb.universe.tf/allow-shared-ip: adguard
spec:
  selector:
    app: adguard
  type: LoadBalancer
  loadBalancerIP: 192.168.1.253
  ports:
    - name: http
      port: 80
      targetPort: 80
      protocol: TCP
    - name: dns-udp
      port: 53
      targetPort: 53
      protocol: UDP
    - name: dns-tcp
      port: 53
      targetPort: 53
      protocol: TCP
