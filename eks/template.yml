Description: Blueprints tracking (qs-1s1r465hk)
Resources:
  ekslabRole36D2E236:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: eks.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/AmazonEKSClusterPolicy
    Metadata:
      aws:cdk:path: eks-lab-stack/eks-lab/eks-lab/Role/Resource
  ekslabControlPlaneSecurityGroup2062B3D3:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: EKS Control Plane Security Group
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic by default
          IpProtocol: "-1"
      VpcId:
        Fn::ImportValue: network-stack:ExportsOutputRefekslabvpcD9F570187088F48F
    Metadata:
      aws:cdk:path: eks-lab-stack/eks-lab/eks-lab/ControlPlaneSecurityGroup/Resource
  ekslabCreationRole2B9FD88E:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              AWS:
                Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :iam::922457306128:root
        Version: "2012-10-17"
    Metadata:
      aws:cdk:path: eks-lab-stack/eks-lab/eks-lab/Resource/CreationRole/Resource
  ekslabCreationRoleDefaultPolicy28EBAF4A:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action: iam:PassRole
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - ekslabRole36D2E236
                  - Arn
              - Fn::GetAtt:
                  - ekslabfargateprofilekarpenterPodExecutionRole5D916E67
                  - Arn
          - Action:
              - eks:CreateCluster
              - eks:CreateFargateProfile
              - eks:DeleteCluster
              - eks:DescribeCluster
              - eks:DescribeUpdate
              - eks:TagResource
              - eks:UntagResource
              - eks:UpdateClusterConfig
              - eks:UpdateClusterVersion
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :eks:eu-west-1:922457306128:cluster/eks-lab
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :eks:eu-west-1:922457306128:cluster/eks-lab/*
          - Action:
              - eks:DeleteFargateProfile
              - eks:DescribeFargateProfile
            Effect: Allow
            Resource:
              Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - :eks:eu-west-1:922457306128:fargateprofile/eks-lab/*
          - Action:
              - ec2:DescribeDhcpOptions
              - ec2:DescribeInstances
              - ec2:DescribeNetworkInterfaces
              - ec2:DescribeRouteTables
              - ec2:DescribeSecurityGroups
              - ec2:DescribeSubnets
              - ec2:DescribeVpcs
              - iam:CreateServiceLinkedRole
              - iam:GetRole
              - iam:listAttachedRolePolicies
            Effect: Allow
            Resource: "*"
        Version: "2012-10-17"
      PolicyName: ekslabCreationRoleDefaultPolicy28EBAF4A
      Roles:
        - Ref: ekslabCreationRole2B9FD88E
    Metadata:
      aws:cdk:path: eks-lab-stack/eks-lab/eks-lab/Resource/CreationRole/DefaultPolicy/Resource
  ekslab2DB1876C:
    Type: Custom::AWSCDK-EKS-Cluster
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - awscdkawseksClusterResourceProviderNestedStackawscdkawseksClusterResourceProviderNestedStackResource9827C454
          - Outputs.ekslabstackekslabawscdkawseksClusterResourceProviderframeworkonEvent1C93FBBFArn
      Config:
        name: eks-lab
        version: "1.21"
        roleArn:
          Fn::GetAtt:
            - ekslabRole36D2E236
            - Arn
        resourcesVpcConfig:
          subnetIds:
            - Fn::ImportValue: network-stack:ExportsOutputRefekslabvpcpublicSubnet1SubnetD0BB21A6E70D152D
            - Fn::ImportValue: network-stack:ExportsOutputRefekslabvpcpublicSubnet2SubnetF2141B16D3231D9F
            - Fn::ImportValue: network-stack:ExportsOutputRefekslabvpcworkersSubnet1SubnetB57A91DC6FE6611F
            - Fn::ImportValue: network-stack:ExportsOutputRefekslabvpcworkersSubnet2SubnetA0C7578E1A9C00FF
          securityGroupIds:
            - Fn::GetAtt:
                - ekslabControlPlaneSecurityGroup2062B3D3
                - GroupId
          endpointPublicAccess: true
          endpointPrivateAccess: true
      AssumeRoleArn:
        Fn::GetAtt:
          - ekslabCreationRole2B9FD88E
          - Arn
      AttributesRevision: 2
    DependsOn:
      - ekslabCreationRoleDefaultPolicy28EBAF4A
      - ekslabCreationRole2B9FD88E
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Metadata:
      aws:cdk:path: eks-lab-stack/eks-lab/eks-lab/Resource/Resource/Default
  ekslabKubectlReadyBarrier27A0AE8A:
    Type: AWS::SSM::Parameter
    Properties:
      Type: String
      Value: aws:cdk:eks:kubectl-ready
    DependsOn:
      - ekslabfargateprofilekarpenterPodExecutionRole5D916E67
      - ekslabfargateprofilekarpenter5D90879C
      - ekslabCreationRoleDefaultPolicy28EBAF4A
      - ekslabCreationRole2B9FD88E
      - ekslab2DB1876C
    Metadata:
      aws:cdk:path: eks-lab-stack/eks-lab/eks-lab/KubectlReadyBarrier
  ekslabMastersRole0C4E731D:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              AWS:
                Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :iam::922457306128:root
        Version: "2012-10-17"
    Metadata:
      aws:cdk:path: eks-lab-stack/eks-lab/eks-lab/MastersRole/Resource
  ekslabAwsAuthmanifest305FCC30:
    Type: Custom::AWSCDK-EKS-KubernetesResource
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - awscdkawseksKubectlProviderNestedStackawscdkawseksKubectlProviderNestedStackResourceA7AEBA6B
          - Outputs.ekslabstackekslabawscdkawseksKubectlProviderframeworkonEvent392A6E81Arn
      Manifest:
        Fn::Join:
          - ""
          - - '[{"apiVersion":"v1","kind":"ConfigMap","metadata":{"name":"aws-auth","namespace":"kube-system","labels":{"aws.cdk.eks/prune-c83378630f7da31c8aa182f06b67892af0b7dff136":""}},"data":{"mapRoles":"[{\"rolearn\":\"'
            - Fn::GetAtt:
                - ekslabMastersRole0C4E731D
                - Arn
            - \",\"username\":\"
            - Fn::GetAtt:
                - ekslabMastersRole0C4E731D
                - Arn
            - \",\"groups\":[\"system:masters\"]},{\"rolearn\":\"
            - Fn::GetAtt:
                - ekslabfargateprofilekarpenterPodExecutionRole5D916E67
                - Arn
            - \",\"username\":\"system:node:{{SessionName}}\",\"groups\":[\"system:bootstrappers\",\"system:nodes\",\"system:node-proxier\"]},{\"rolearn\":\"
            - Fn::GetAtt:
                - ekslabkarpenternoderoleBB52BCCA
                - Arn
            - \",\"username\":\"system:node:{{EC2PrivateDNSName}}\",\"groups\":[\"system:bootstrapper\",\"system:nodes\"]}]","mapUsers":"[]","mapAccounts":"[]"}}]
      ClusterName:
        Ref: ekslab2DB1876C
      RoleArn:
        Fn::GetAtt:
          - ekslabCreationRole2B9FD88E
          - Arn
      PruneLabel: aws.cdk.eks/prune-c83378630f7da31c8aa182f06b67892af0b7dff136
      Overwrite: true
    DependsOn:
      - ekslabKubectlReadyBarrier27A0AE8A
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Metadata:
      aws:cdk:path: eks-lab-stack/eks-lab/eks-lab/AwsAuth/manifest/Resource/Default
  ekslabfargateprofilekarpenterPodExecutionRole5D916E67:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: eks-fargate-pods.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/AmazonEKSFargatePodExecutionRolePolicy
    Metadata:
      aws:cdk:path: eks-lab-stack/eks-lab/eks-lab/fargate-profile-karpenter/PodExecutionRole/Resource
  ekslabfargateprofilekarpenter5D90879C:
    Type: Custom::AWSCDK-EKS-FargateProfile
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - awscdkawseksClusterResourceProviderNestedStackawscdkawseksClusterResourceProviderNestedStackResource9827C454
          - Outputs.ekslabstackekslabawscdkawseksClusterResourceProviderframeworkonEvent1C93FBBFArn
      AssumeRoleArn:
        Fn::GetAtt:
          - ekslabCreationRole2B9FD88E
          - Arn
      Config:
        clusterName:
          Ref: ekslab2DB1876C
        fargateProfileName: karpenter
        podExecutionRoleArn:
          Fn::GetAtt:
            - ekslabfargateprofilekarpenterPodExecutionRole5D916E67
            - Arn
        selectors:
          - namespace: karpenter
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Metadata:
      aws:cdk:path: eks-lab-stack/eks-lab/eks-lab/fargate-profile-karpenter/Resource/Default
  ekslabawsloadbalancercontrollerConditionJson3D317AB6:
    Type: Custom::AWSCDKCfnJson
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - AWSCDKCfnUtilsProviderCustomResourceProviderHandlerCF82AA57
          - Arn
      Value:
        Fn::Join:
          - ""
          - - '{"'
            - Fn::Select:
                - 1
                - Fn::Split:
                    - :oidc-provider/
                    - Ref: ekslabOpenIdConnectProviderCCDC3625
            - :aud":"sts.amazonaws.com","
            - Fn::Select:
                - 1
                - Fn::Split:
                    - :oidc-provider/
                    - Ref: ekslabOpenIdConnectProviderCCDC3625
            - :sub":"system:serviceaccount:kube-system:aws-load-balancer-controller"}
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Metadata:
      aws:cdk:path: eks-lab-stack/eks-lab/eks-lab/aws-load-balancer-controller/ConditionJson/Resource/Default
  ekslabawsloadbalancercontrollerRole4BBFAA5A:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRoleWithWebIdentity
            Condition:
              StringEquals:
                Fn::GetAtt:
                  - ekslabawsloadbalancercontrollerConditionJson3D317AB6
                  - Value
            Effect: Allow
            Principal:
              Federated:
                Ref: ekslabOpenIdConnectProviderCCDC3625
        Version: "2012-10-17"
    Metadata:
      aws:cdk:path: eks-lab-stack/eks-lab/eks-lab/aws-load-balancer-controller/Role/Resource
  ekslabawsloadbalancercontrollerRoleDefaultPolicy1EBF3A79:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action: iam:CreateServiceLinkedRole
            Condition:
              StringEquals:
                iam:AWSServiceName: elasticloadbalancing.amazonaws.com
            Effect: Allow
            Resource: "*"
          - Action:
              - acm:DescribeCertificate
              - acm:ListCertificates
              - cognito-idp:DescribeUserPoolClient
              - ec2:AuthorizeSecurityGroupIngress
              - ec2:CreateSecurityGroup
              - ec2:DescribeAccountAttributes
              - ec2:DescribeAddresses
              - ec2:DescribeAvailabilityZones
              - ec2:DescribeCoipPools
              - ec2:DescribeInstances
              - ec2:DescribeInternetGateways
              - ec2:DescribeNetworkInterfaces
              - ec2:DescribeSecurityGroups
              - ec2:DescribeSubnets
              - ec2:DescribeTags
              - ec2:DescribeVpcPeeringConnections
              - ec2:DescribeVpcs
              - ec2:GetCoipPoolUsage
              - ec2:RevokeSecurityGroupIngress
              - elasticloadbalancing:AddListenerCertificates
              - elasticloadbalancing:CreateListener
              - elasticloadbalancing:CreateRule
              - elasticloadbalancing:DeleteListener
              - elasticloadbalancing:DeleteRule
              - elasticloadbalancing:DescribeListenerCertificates
              - elasticloadbalancing:DescribeListeners
              - elasticloadbalancing:DescribeLoadBalancerAttributes
              - elasticloadbalancing:DescribeLoadBalancers
              - elasticloadbalancing:DescribeRules
              - elasticloadbalancing:DescribeSSLPolicies
              - elasticloadbalancing:DescribeTags
              - elasticloadbalancing:DescribeTargetGroupAttributes
              - elasticloadbalancing:DescribeTargetGroups
              - elasticloadbalancing:DescribeTargetHealth
              - elasticloadbalancing:ModifyListener
              - elasticloadbalancing:ModifyRule
              - elasticloadbalancing:RemoveListenerCertificates
              - elasticloadbalancing:SetWebAcl
              - iam:GetServerCertificate
              - iam:ListServerCertificates
              - shield:CreateProtection
              - shield:DeleteProtection
              - shield:DescribeProtection
              - shield:GetSubscriptionState
              - waf-regional:AssociateWebACL
              - waf-regional:DisassociateWebACL
              - waf-regional:GetWebACL
              - waf-regional:GetWebACLForResource
              - wafv2:AssociateWebACL
              - wafv2:DisassociateWebACL
              - wafv2:GetWebACL
              - wafv2:GetWebACLForResource
            Effect: Allow
            Resource: "*"
          - Action: ec2:CreateTags
            Condition:
              StringEquals:
                ec2:CreateAction: CreateSecurityGroup
              "Null":
                aws:RequestTag/elbv2.k8s.aws/cluster: "false"
            Effect: Allow
            Resource:
              Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - :ec2:*:*:security-group/*
          - Action:
              - ec2:CreateTags
              - ec2:DeleteTags
            Condition:
              "Null":
                aws:RequestTag/elbv2.k8s.aws/cluster: "true"
                aws:ResourceTag/elbv2.k8s.aws/cluster: "false"
            Effect: Allow
            Resource:
              Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - :ec2:*:*:security-group/*
          - Action:
              - ec2:AuthorizeSecurityGroupIngress
              - ec2:DeleteSecurityGroup
              - ec2:RevokeSecurityGroupIngress
              - elasticloadbalancing:DeleteLoadBalancer
              - elasticloadbalancing:DeleteTargetGroup
              - elasticloadbalancing:ModifyLoadBalancerAttributes
              - elasticloadbalancing:ModifyTargetGroup
              - elasticloadbalancing:ModifyTargetGroupAttributes
              - elasticloadbalancing:SetIpAddressType
              - elasticloadbalancing:SetSecurityGroups
              - elasticloadbalancing:SetSubnets
            Condition:
              "Null":
                aws:ResourceTag/elbv2.k8s.aws/cluster: "false"
            Effect: Allow
            Resource: "*"
          - Action:
              - elasticloadbalancing:CreateLoadBalancer
              - elasticloadbalancing:CreateTargetGroup
            Condition:
              "Null":
                aws:RequestTag/elbv2.k8s.aws/cluster: "false"
            Effect: Allow
            Resource: "*"
          - Action:
              - elasticloadbalancing:AddTags
              - elasticloadbalancing:RemoveTags
            Condition:
              "Null":
                aws:RequestTag/elbv2.k8s.aws/cluster: "true"
                aws:ResourceTag/elbv2.k8s.aws/cluster: "false"
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :elasticloadbalancing:*:*:loadbalancer/app/*/*
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :elasticloadbalancing:*:*:loadbalancer/net/*/*
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :elasticloadbalancing:*:*:targetgroup/*/*
          - Action:
              - elasticloadbalancing:AddTags
              - elasticloadbalancing:RemoveTags
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :elasticloadbalancing:*:*:listener-rule/app/*/*/*
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :elasticloadbalancing:*:*:listener-rule/net/*/*/*
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :elasticloadbalancing:*:*:listener/app/*/*/*
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :elasticloadbalancing:*:*:listener/net/*/*/*
          - Action:
              - elasticloadbalancing:DeregisterTargets
              - elasticloadbalancing:RegisterTargets
            Effect: Allow
            Resource:
              Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - :elasticloadbalancing:*:*:targetgroup/*/*
        Version: "2012-10-17"
      PolicyName: ekslabawsloadbalancercontrollerRoleDefaultPolicy1EBF3A79
      Roles:
        - Ref: ekslabawsloadbalancercontrollerRole4BBFAA5A
    Metadata:
      aws:cdk:path: eks-lab-stack/eks-lab/eks-lab/aws-load-balancer-controller/Role/DefaultPolicy/Resource
  ekslabawsloadbalancercontrollermanifestawsloadbalancercontrollerServiceAccountResource8E6457C5:
    Type: Custom::AWSCDK-EKS-KubernetesResource
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - awscdkawseksKubectlProviderNestedStackawscdkawseksKubectlProviderNestedStackResourceA7AEBA6B
          - Outputs.ekslabstackekslabawscdkawseksKubectlProviderframeworkonEvent392A6E81Arn
      Manifest:
        Fn::Join:
          - ""
          - - '[{"apiVersion":"v1","kind":"ServiceAccount","metadata":{"name":"aws-load-balancer-controller","namespace":"kube-system","labels":{"aws.cdk.eks/prune-c8b829835bb5d16bdedd9fa7ace9f3117eb8a32d8a":"","app.kubernetes.io/name":"aws-load-balancer-controller"},"annotations":{"eks.amazonaws.com/role-arn":"'
            - Fn::GetAtt:
                - ekslabawsloadbalancercontrollerRole4BBFAA5A
                - Arn
            - '"}}}]'
      ClusterName:
        Ref: ekslab2DB1876C
      RoleArn:
        Fn::GetAtt:
          - ekslabCreationRole2B9FD88E
          - Arn
      PruneLabel: aws.cdk.eks/prune-c8b829835bb5d16bdedd9fa7ace9f3117eb8a32d8a
    DependsOn:
      - ekslabKubectlReadyBarrier27A0AE8A
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Metadata:
      aws:cdk:path: eks-lab-stack/eks-lab/eks-lab/aws-load-balancer-controller/manifest-aws-load-balancer-controllerServiceAccountResource/Resource/Default
  ekslabOpenIdConnectProviderCCDC3625:
    Type: Custom::AWSCDKOpenIdConnectProvider
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - CustomAWSCDKOpenIdConnectProviderCustomResourceProviderHandlerF2C543E0
          - Arn
      ClientIDList:
        - sts.amazonaws.com
      ThumbprintList:
        - 9e99a48a9960b14926bb7f3b02e22da2b0ab7280
      Url:
        Fn::GetAtt:
          - ekslab2DB1876C
          - OpenIdConnectIssuerUrl
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Metadata:
      aws:cdk:path: eks-lab-stack/eks-lab/eks-lab/OpenIdConnectProvider/Resource/Default
  ekslabchartawsloadbalancercontroller31776E9D:
    Type: Custom::AWSCDK-EKS-HelmChart
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - awscdkawseksKubectlProviderNestedStackawscdkawseksKubectlProviderNestedStackResourceA7AEBA6B
          - Outputs.ekslabstackekslabawscdkawseksKubectlProviderframeworkonEvent392A6E81Arn
      ClusterName:
        Ref: ekslab2DB1876C
      RoleArn:
        Fn::GetAtt:
          - ekslabCreationRole2B9FD88E
          - Arn
      Release: aws-load-balancer-controller
      Chart: aws-load-balancer-controller
      Version: 1.4.2
      Values:
        Fn::Join:
          - ""
          - - '{"clusterName":"'
            - Ref: ekslab2DB1876C
            - '","serviceAccount":{"create":false,"name":"aws-load-balancer-controller"},"enableShield":false,"enableWaf":false,"enableWafv2":false,"createIngressClassResource":true,"ingressClass":"alb","region":"eu-west-1","image":{"repository":"602401143452.dkr.ecr.eu-west-1.amazonaws.com/amazon/aws-load-balancer-controller"},"vpcId":"'
            - Fn::ImportValue: network-stack:ExportsOutputRefekslabvpcD9F570187088F48F
            - '"}'
      Namespace: kube-system
      Repository: https://aws.github.io/eks-charts
      CreateNamespace: true
    DependsOn:
      - ekslabawsloadbalancercontrollerConditionJson3D317AB6
      - ekslabawsloadbalancercontrollermanifestawsloadbalancercontrollerServiceAccountResource8E6457C5
      - ekslabawsloadbalancercontrollerRoleDefaultPolicy1EBF3A79
      - ekslabawsloadbalancercontrollerRole4BBFAA5A
      - ekslabKubectlReadyBarrier27A0AE8A
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Metadata:
      aws:cdk:path: eks-lab-stack/eks-lab/eks-lab/chart-aws-load-balancer-controller/Resource/Default
  ekslabchartcalicooperator42A6DE3A:
    Type: Custom::AWSCDK-EKS-HelmChart
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - awscdkawseksKubectlProviderNestedStackawscdkawseksKubectlProviderNestedStackResourceA7AEBA6B
          - Outputs.ekslabstackekslabawscdkawseksKubectlProviderframeworkonEvent392A6E81Arn
      ClusterName:
        Ref: ekslab2DB1876C
      RoleArn:
        Fn::GetAtt:
          - ekslabCreationRole2B9FD88E
          - Arn
      Release: bp-addon-calico-operator
      Chart: tigera-operator
      Version: v3.23.3
      Values: "{}"
      Namespace: calico-operator
      Repository: https://projectcalico.docs.tigera.io/charts
      CreateNamespace: true
    DependsOn:
      - ekslabKubectlReadyBarrier27A0AE8A
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Metadata:
      aws:cdk:path: eks-lab-stack/eks-lab/eks-lab/chart-calico-operator/Resource/Default
  ekslabchartmetricsserver87892A66:
    Type: Custom::AWSCDK-EKS-HelmChart
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - awscdkawseksKubectlProviderNestedStackawscdkawseksKubectlProviderNestedStackResourceA7AEBA6B
          - Outputs.ekslabstackekslabawscdkawseksKubectlProviderframeworkonEvent392A6E81Arn
      ClusterName:
        Ref: ekslab2DB1876C
      RoleArn:
        Fn::GetAtt:
          - ekslabCreationRole2B9FD88E
          - Arn
      Release: blueprints-addon-metrics-server
      Chart: metrics-server
      Version: 3.8.2
      Values: "{}"
      Namespace: kube-system
      Repository: https://kubernetes-sigs.github.io/metrics-server
      CreateNamespace: true
    DependsOn:
      - ekslabKubectlReadyBarrier27A0AE8A
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Metadata:
      aws:cdk:path: eks-lab-stack/eks-lab/eks-lab/chart-metrics-server/Resource/Default
  ekslabkarpenternoderoleBB52BCCA:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                Fn::Join:
                  - ""
                  - - ec2.
                    - Ref: AWS::URLSuffix
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/AmazonEKSWorkerNodePolicy
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/AmazonEKS_CNI_Policy
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/AmazonSSMManagedInstanceCore
    Metadata:
      aws:cdk:path: eks-lab-stack/eks-lab/eks-lab/karpenter-node-role/Resource
  ekslabkarpenterinstanceprofileAA61FA39:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - Ref: ekslabkarpenternoderoleBB52BCCA
      InstanceProfileName: KarpenterNodeInstanceProfile-ae772a0db5c6ae283223bf9577381a70
      Path: /
    Metadata:
      aws:cdk:path: eks-lab-stack/eks-lab/eks-lab/karpenter-instance-profile
  ekslabblueprintsaddonkarpentermanagedpolicy669BBF4F:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - ec2:CreateFleet
              - ec2:CreateLaunchTemplate
              - ec2:CreateTags
              - ec2:DeleteLaunchTemplate
              - ec2:DescribeAvailabilityZones
              - ec2:DescribeInstanceTypeOfferings
              - ec2:DescribeInstanceTypes
              - ec2:DescribeInstances
              - ec2:DescribeLaunchTemplates
              - ec2:DescribeSecurityGroups
              - ec2:DescribeSubnets
              - ec2:RunInstances
              - ec2:TerminateInstances
              - iam:PassRole
              - ssm:GetParameter
            Effect: Allow
            Resource: "*"
        Version: "2012-10-17"
      Description: ""
      Path: /
    Metadata:
      aws:cdk:path: eks-lab-stack/eks-lab/eks-lab/blueprints-addon-karpenter-managed-policy/Resource
  ekslabblueprintsaddonkarpentersaConditionJson726F99C3:
    Type: Custom::AWSCDKCfnJson
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - AWSCDKCfnUtilsProviderCustomResourceProviderHandlerCF82AA57
          - Arn
      Value:
        Fn::Join:
          - ""
          - - '{"'
            - Fn::Select:
                - 1
                - Fn::Split:
                    - :oidc-provider/
                    - Ref: ekslabOpenIdConnectProviderCCDC3625
            - :aud":"sts.amazonaws.com","
            - Fn::Select:
                - 1
                - Fn::Split:
                    - :oidc-provider/
                    - Ref: ekslabOpenIdConnectProviderCCDC3625
            - :sub":"system:serviceaccount:karpenter:blueprints-addon-karpenter"}
    DependsOn:
      - karpenternamespacestructC6800395
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Metadata:
      aws:cdk:path: eks-lab-stack/eks-lab/eks-lab/blueprints-addon-karpenter-sa/ConditionJson/Resource/Default
  ekslabblueprintsaddonkarpentersaRoleA3313F59:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRoleWithWebIdentity
            Condition:
              StringEquals:
                Fn::GetAtt:
                  - ekslabblueprintsaddonkarpentersaConditionJson726F99C3
                  - Value
            Effect: Allow
            Principal:
              Federated:
                Ref: ekslabOpenIdConnectProviderCCDC3625
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Ref: ekslabblueprintsaddonkarpentermanagedpolicy669BBF4F
    DependsOn:
      - karpenternamespacestructC6800395
    Metadata:
      aws:cdk:path: eks-lab-stack/eks-lab/eks-lab/blueprints-addon-karpenter-sa/Role/Resource
  ekslabblueprintsaddonkarpentersamanifestblueprintsaddonkarpentersaServiceAccountResource8FAF0243:
    Type: Custom::AWSCDK-EKS-KubernetesResource
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - awscdkawseksKubectlProviderNestedStackawscdkawseksKubectlProviderNestedStackResourceA7AEBA6B
          - Outputs.ekslabstackekslabawscdkawseksKubectlProviderframeworkonEvent392A6E81Arn
      Manifest:
        Fn::Join:
          - ""
          - - '[{"apiVersion":"v1","kind":"ServiceAccount","metadata":{"name":"blueprints-addon-karpenter","namespace":"karpenter","labels":{"aws.cdk.eks/prune-c82afe1d2e9de94923f72c97ba90d8afa598e20092":"","app.kubernetes.io/name":"blueprints-addon-karpenter"},"annotations":{"eks.amazonaws.com/role-arn":"'
            - Fn::GetAtt:
                - ekslabblueprintsaddonkarpentersaRoleA3313F59
                - Arn
            - '"}}}]'
      ClusterName:
        Ref: ekslab2DB1876C
      RoleArn:
        Fn::GetAtt:
          - ekslabCreationRole2B9FD88E
          - Arn
      PruneLabel: aws.cdk.eks/prune-c82afe1d2e9de94923f72c97ba90d8afa598e20092
    DependsOn:
      - ekslabKubectlReadyBarrier27A0AE8A
      - karpenternamespacestructC6800395
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Metadata:
      aws:cdk:path: eks-lab-stack/eks-lab/eks-lab/blueprints-addon-karpenter-sa/manifest-blueprints-addon-karpenter-saServiceAccountResource/Resource/Default
  ekslabchartkarpenterCCA454F4:
    Type: Custom::AWSCDK-EKS-HelmChart
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - awscdkawseksKubectlProviderNestedStackawscdkawseksKubectlProviderNestedStackResourceA7AEBA6B
          - Outputs.ekslabstackekslabawscdkawseksKubectlProviderframeworkonEvent392A6E81Arn
      ClusterName:
        Ref: ekslab2DB1876C
      RoleArn:
        Fn::GetAtt:
          - ekslabCreationRole2B9FD88E
          - Arn
      Release: blueprints-addon-karpenter
      Chart: karpenter
      Version: 0.13.2
      Wait: true
      Values:
        Fn::Join:
          - ""
          - - '{"clusterEndpoint":"'
            - Fn::GetAtt:
                - ekslab2DB1876C
                - Endpoint
            - '","clusterName":"'
            - Ref: ekslab2DB1876C
            - '","aws":{"defaultInstanceProfile":"KarpenterNodeInstanceProfile-ae772a0db5c6ae283223bf9577381a70"},"serviceAccount":{"create":false,"name":"blueprints-addon-karpenter","annotations":{"eks.amazonaws.com/role-arn":"'
            - Fn::GetAtt:
                - ekslabblueprintsaddonkarpentersaRoleA3313F59
                - Arn
            - '"}}}'
      Namespace: karpenter
      Repository: https://charts.karpenter.sh
    DependsOn:
      - ekslabKubectlReadyBarrier27A0AE8A
      - karpenternamespacestructC6800395
      - vpccniaddOn
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Metadata:
      aws:cdk:path: eks-lab-stack/eks-lab/eks-lab/chart-karpenter/Resource/Default
  ekslabmanifestdefaultprovisionerDEC9B114:
    Type: Custom::AWSCDK-EKS-KubernetesResource
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - awscdkawseksKubectlProviderNestedStackawscdkawseksKubectlProviderNestedStackResourceA7AEBA6B
          - Outputs.ekslabstackekslabawscdkawseksKubectlProviderframeworkonEvent392A6E81Arn
      Manifest: '[{"apiVersion":"karpenter.sh/v1alpha5","kind":"Provisioner","metadata":{"name":"default","labels":{"aws.cdk.eks/prune-c8a32aebf3e9c8a36113f5e1f7865cd0f52c6e175b":""}},"spec":{"requirements":[{"key":"karpenter.sh/capacity-type","operator":"In","values":["spot"]},{"key":"kubernetes.io/arch","operator":"In","values":["amd64","arm64"]},{"key":"topology.kubernetes.io/zone","operator":"In","values":["eu-west-1a","eu-west-1b"]}],"taints":[],"provider":{"amiFamily":"AL2","subnetSelector":{"karpenter.sh/discovery":"eks-lab"},"securityGroupSelector":{"karpenter.sh/discovery":"eks-lab"}},"ttlSecondsAfterEmpty":30}}]'
      ClusterName:
        Ref: ekslab2DB1876C
      RoleArn:
        Fn::GetAtt:
          - ekslabCreationRole2B9FD88E
          - Arn
      PruneLabel: aws.cdk.eks/prune-c8a32aebf3e9c8a36113f5e1f7865cd0f52c6e175b
    DependsOn:
      - ekslabchartkarpenterCCA454F4
      - ekslabKubectlReadyBarrier27A0AE8A
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Metadata:
      aws:cdk:path: eks-lab-stack/eks-lab/eks-lab/manifest-default-provisioner/Resource/Default
  awscdkawseksClusterResourceProviderNestedStackawscdkawseksClusterResourceProviderNestedStackResource9827C454:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:
        Fn::Join:
          - ""
          - - https://s3.eu-west-1.
            - Ref: AWS::URLSuffix
            - /cdk-hnb659fds-assets-922457306128-eu-west-1/420bc55c7cd5c48faa178e6c48306381ff5f4f54f2f38f677bae036e40df382c.json
      Parameters:
        referencetoekslabstackekslabCreationRoleD228BEDCArn:
          Fn::GetAtt:
            - ekslabCreationRole2B9FD88E
            - Arn
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Metadata:
      aws:cdk:path: eks-lab-stack/eks-lab/@aws-cdk--aws-eks.ClusterResourceProvider.NestedStack/@aws-cdk--aws-eks.ClusterResourceProvider.NestedStackResource
      aws:asset:path: ekslabstackekslabawscdkawseksClusterResourceProvider41BEDAED.nested.template.json
      aws:asset:property: TemplateURL
  awscdkawseksKubectlProviderNestedStackawscdkawseksKubectlProviderNestedStackResourceA7AEBA6B:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:
        Fn::Join:
          - ""
          - - https://s3.eu-west-1.
            - Ref: AWS::URLSuffix
            - /cdk-hnb659fds-assets-922457306128-eu-west-1/3cdc701593f623e3f0f91d5797c1c199d217b1ee1b61d941fd1ce11d73feb367.json
      Parameters:
        referencetoekslabstackekslab9830A8D5Arn:
          Fn::GetAtt:
            - ekslab2DB1876C
            - Arn
        referencetoekslabstackekslabCreationRoleD228BEDCArn:
          Fn::GetAtt:
            - ekslabCreationRole2B9FD88E
            - Arn
        referencetoekslabstackekslab9830A8D5ClusterSecurityGroupId:
          Fn::GetAtt:
            - ekslab2DB1876C
            - ClusterSecurityGroupId
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Metadata:
      aws:cdk:path: eks-lab-stack/eks-lab/@aws-cdk--aws-eks.KubectlProvider.NestedStack/@aws-cdk--aws-eks.KubectlProvider.NestedStackResource
      aws:asset:path: ekslabstackekslabawscdkawseksKubectlProvider49F28B54.nested.template.json
      aws:asset:property: TemplateURL
  CustomAWSCDKOpenIdConnectProviderCustomResourceProviderRole517FED65:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
      ManagedPolicyArns:
        - Fn::Sub: arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: Inline
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Resource: "*"
                Action:
                  - iam:CreateOpenIDConnectProvider
                  - iam:DeleteOpenIDConnectProvider
                  - iam:UpdateOpenIDConnectProviderThumbprint
                  - iam:AddClientIDToOpenIDConnectProvider
                  - iam:RemoveClientIDFromOpenIDConnectProvider
    Metadata:
      aws:cdk:path: eks-lab-stack/eks-lab/Custom::AWSCDKOpenIdConnectProviderCustomResourceProvider/Role
  CustomAWSCDKOpenIdConnectProviderCustomResourceProviderHandlerF2C543E0:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: cdk-hnb659fds-assets-922457306128-eu-west-1
        S3Key: 494e82802f093e633e580188c7937aef9d6ee0ad4a788d58c647e6bea26d2915.zip
      Timeout: 900
      MemorySize: 128
      Handler: __entrypoint__.handler
      Role:
        Fn::GetAtt:
          - CustomAWSCDKOpenIdConnectProviderCustomResourceProviderRole517FED65
          - Arn
      Runtime: nodejs14.x
    DependsOn:
      - CustomAWSCDKOpenIdConnectProviderCustomResourceProviderRole517FED65
    Metadata:
      aws:cdk:path: eks-lab-stack/eks-lab/Custom::AWSCDKOpenIdConnectProviderCustomResourceProvider/Handler
      aws:asset:path: asset.494e82802f093e633e580188c7937aef9d6ee0ad4a788d58c647e6bea26d2915
      aws:asset:property: Code
  AWSCDKCfnUtilsProviderCustomResourceProviderRoleFE0EE867:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
      ManagedPolicyArns:
        - Fn::Sub: arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    Metadata:
      aws:cdk:path: eks-lab-stack/eks-lab/AWSCDKCfnUtilsProviderCustomResourceProvider/Role
  AWSCDKCfnUtilsProviderCustomResourceProviderHandlerCF82AA57:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: cdk-hnb659fds-assets-922457306128-eu-west-1
        S3Key: a97987a1729ad440a42cac8aa979b932696afb2dc47dec373aad1a333a1cdbfc.zip
      Timeout: 900
      MemorySize: 128
      Handler: __entrypoint__.handler
      Role:
        Fn::GetAtt:
          - AWSCDKCfnUtilsProviderCustomResourceProviderRoleFE0EE867
          - Arn
      Runtime: nodejs14.x
    DependsOn:
      - AWSCDKCfnUtilsProviderCustomResourceProviderRoleFE0EE867
    Metadata:
      aws:cdk:path: eks-lab-stack/eks-lab/AWSCDKCfnUtilsProviderCustomResourceProvider/Handler
      aws:asset:path: asset.a97987a1729ad440a42cac8aa979b932696afb2dc47dec373aad1a333a1cdbfc
      aws:asset:property: Code
  corednsaddOn:
    Type: AWS::EKS::Addon
    Properties:
      AddonName: coredns
      ClusterName:
        Ref: ekslab2DB1876C
      AddonVersion: v1.8.4-eksbuild.1
      ResolveConflicts: OVERWRITE
    Metadata:
      aws:cdk:path: eks-lab-stack/eks-lab/coredns-addOn
  kubeproxyaddOn:
    Type: AWS::EKS::Addon
    Properties:
      AddonName: kube-proxy
      ClusterName:
        Ref: ekslab2DB1876C
      AddonVersion: v1.21.2-eksbuild.2
      ResolveConflicts: OVERWRITE
    Metadata:
      aws:cdk:path: eks-lab-stack/eks-lab/kube-proxy-addOn
  vpccniaddOn:
    Type: AWS::EKS::Addon
    Properties:
      AddonName: vpc-cni
      ClusterName:
        Ref: ekslab2DB1876C
      AddonVersion: v1.11.2-eksbuild.1
      ResolveConflicts: OVERWRITE
    Metadata:
      aws:cdk:path: eks-lab-stack/eks-lab/vpc-cni-addOn
  karpenternamespacestructC6800395:
    Type: Custom::AWSCDK-EKS-KubernetesResource
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - awscdkawseksKubectlProviderNestedStackawscdkawseksKubectlProviderNestedStackResourceA7AEBA6B
          - Outputs.ekslabstackekslabawscdkawseksKubectlProviderframeworkonEvent392A6E81Arn
      Manifest: '[{"apiVersion":"v1","kind":"Namespace","metadata":{"name":"karpenter","labels":{"aws.cdk.eks/prune-c8495ecad1ef88f39a632ebae90c13174ababb7e31":""}}}]'
      ClusterName:
        Ref: ekslab2DB1876C
      RoleArn:
        Fn::GetAtt:
          - ekslabCreationRole2B9FD88E
          - Arn
      PruneLabel: aws.cdk.eks/prune-c8495ecad1ef88f39a632ebae90c13174ababb7e31
      Overwrite: true
    DependsOn:
      - ekslabKubectlReadyBarrier27A0AE8A
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Metadata:
      aws:cdk:path: eks-lab-stack/eks-lab/karpenter-namespace-struct/Resource/Default
  CDKMetadata:
    Type: AWS::CDK::Metadata
    Properties:
      Analytics: v2:deflate64:H4sIAAAAAAAA/1VQ0U7DMAz8Ft6zANsDvFaVgIHQpu4DUJa4ndfWqWKn01T138k6sdEnO6fL+e6WerXSTw/mxAvr6kWDez3sxNhaJehngJr1kDeRBYLKTpxFOaivuIdAIMDfhrAEFvVmQmUEtsGX2IDaQejRQmatjyRq0wGtXe6JwEri9OiS3Ac0bX4wQVReUuacp1GhafVQ+CSRsGlufYP2fHnetzWxGLK3c8mGqcDdCTNgVGCXKRXYGFDO78HH7kKaAeOo8pTStwWwj8FeDfzt/8FNlC5Onj/Z0yQ09TX/fkuZMYMkRoVUjYq8A33kx/75Vb+k3o+MuAipI2xBF9f5C5q1vfqTAQAA
    Metadata:
      aws:cdk:path: eks-lab-stack/eks-lab/CDKMetadata/Default
Outputs:
  ekslabClusterName89BB029E:
    Value:
      Ref: ekslab2DB1876C
  ekslabConfigCommand2B3F8426:
    Value:
      Fn::Join:
        - ""
        - - "aws eks update-kubeconfig --name "
          - Ref: ekslab2DB1876C
          - " --region eu-west-1 --role-arn "
          - Fn::GetAtt:
              - ekslabMastersRole0C4E731D
              - Arn
  ekslabGetTokenCommandC31BADBF:
    Value:
      Fn::Join:
        - ""
        - - "aws eks get-token --cluster-name "
          - Ref: ekslab2DB1876C
          - " --region eu-west-1 --role-arn "
          - Fn::GetAtt:
              - ekslabMastersRole0C4E731D
              - Arn
Parameters:
  BootstrapVersion:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /cdk-bootstrap/hnb659fds/version
    Description: Version of the CDK Bootstrap resources in this environment, automatically retrieved from SSM Parameter Store. [cdk:skip]
Rules:
  CheckBootstrapVersion:
    Assertions:
      - Assert:
          Fn::Not:
            - Fn::Contains:
                - - "1"
                  - "2"
                  - "3"
                  - "4"
                  - "5"
                - Ref: BootstrapVersion
        AssertDescription: CDK bootstrap stack version 6 required. Please run 'cdk bootstrap' with a recent version of the CDK CLI.

