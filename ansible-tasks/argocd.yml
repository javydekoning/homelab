---
- name: Get latest release of argoproj/applicationset
  register: argoApplicationsetLatestVersion
  community.general.github_release:
    user: argoproj
    repo: applicationset
    action: latest_release

- name: Download argo manifests to the cluster.
  ansible.builtin.get_url:
    url: https://raw.githubusercontent.com/argoproj-labs/applicationset/{{argoApplicationsetLatestVersion.tag}}/manifests/install-with-argo-cd.yaml
    dest: ~/argocd-install.yaml
    mode: "0664"

- name: Create argocd k8s namespace
  kubernetes.core.k8s:
    name: argocd
    api_version: v1
    kind: Namespace
    state: present

- name: Apply argo manifests to the cluster.
  retries: 3
  delay: 60
  kubernetes.core.k8s:
    state: present
    namespace: argocd
    src: ~/argocd-install.yaml
