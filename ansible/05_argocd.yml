# ---
- name: 05-Argo_ensure_namespace
  kubernetes.core.k8s:
    name: argocd
    api_version: v1
    kind: Namespace
    state: present

- name: 05-Argo_copy_k8s_folder_to_host_homedir
  ansible.builtin.copy:
    src: ./k8s/argo-application-sets/argo-cd/
    dest: /{{ansible_user}}/argo-application-sets/argo-cd/

- name: 05-Argo_render_chart
  kubernetes.core.helm_template:
    name: argo-cd
    chart_ref: /{{ansible_user}}/cluster-critical/argo-cd/
    dependency_update: true
    release_namespace: argocd
    values_files:
      - /{{ansible_user}}/cluster-critical/argo-cd/values.yaml
  register: result
  changed_when: False

- name: 05-Argo_apply_rendered_chart
  kubernetes.core.k8s:
    state: present
    definition: "{{ result.stdout }}"
    wait: true

- name: 05-Argo_apply_application_sets
  kubernetes.core.k8s:
    state: present
    src: "{{ item }}"
  loop:
    - https://raw.githubusercontent.com/javydekoning/homelab/main/k8s/argo-application-sets/cluster-apps-application-set.yaml
    - https://raw.githubusercontent.com/javydekoning/homelab/main/k8s/argo-application-sets/cluster-critical-application-set.yaml
    - https://raw.githubusercontent.com/javydekoning/homelab/main/k8s/argo-application-sets/config-application-set.yaml
    - https://raw.githubusercontent.com/javydekoning/homelab/main/k8s/argo-application-sets/custom-application-set.yaml
    - https://raw.githubusercontent.com/javydekoning/homelab/main/k8s/argo-application-sets/dvr-application-set.yaml
    - https://raw.githubusercontent.com/javydekoning/homelab/main/k8s/argo-application-sets/smarthome-application-set.yaml
    - https://raw.githubusercontent.com/javydekoning/homelab/main/k8s/monitoring/gatus/application.yaml
