---
- name: 05-Argo_install_or_upgrade_helm_diff
  shell: |-
    if helm plugin list | grep diff; then
        helm plugin update diff
    else
        helm plugin install https://github.com/databus23/helm-diff
    fi

# Needs if statement. If argo is already installed via helm, argocd takes over.
- name: 05-Argo_copy_k8s_folder_to_host_homedir
  ansible.builtin.copy:
    src: ./k8s/
    dest: /{{ansible_user}}/k8s/

- name: 05-Argo_helm_build_dependency
  shell: |-
    cd /{{ansible_user}}/k8s/cluster-critical/argo-cd
    helm dependency update

- name: 05-Argo_install_chart
  kubernetes.core.helm:
    name: argo-cd
    chart_ref: /{{ansible_user}}/k8s/cluster-critical/argo-cd/
    # Waiting for kubernetes.core 2.4
    # https://github.com/ansible-collections/kubernetes.core/issues/525
    # https://github.com/ansible-collections/kubernetes.core/tags
    # dependency_update: true
    release_namespace: argocd
    create_namespace: true
    values_files:
      - /{{ansible_user}}/k8s/cluster-critical/argo-cd/values.yaml

- name: 05-Argo_apply_/k8s/cluster-critical/application-set.yaml
  kubernetes.core.k8s:
    state: present
    src: /{{ansible_user}}/k8s/cluster-critical/application-set.yaml

- name: 05-Argo_apply_/k8s/cluster-critical/config-application-set.yaml
  kubernetes.core.k8s:
    state: present
    src: /{{ansible_user}}/k8s/cluster-critical/config-application-set.yaml
